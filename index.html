<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GPS Tracker - Live Navigation</title>
    <meta name="description" content="Real-time GPS tracking with Google Maps style interface">

    <!-- Leaflet.js CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Google Fonts - Inter for modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <style>
        /* ========================================
           CSS VARIABLES - Google Maps Theme
           ======================================== */
        :root {
            --primary: #4285F4;
            --primary-dark: #1a73e8;
            --danger: #EA4335;
            --success: #34A853;
            --warning: #FBBC04;
            --surface: #ffffff;
            --surface-variant: #f8f9fa;
            --on-surface: #202124;
            --on-surface-variant: #5f6368;
            --outline: #dadce0;
            --shadow-sm: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
            --shadow-md: 0 1px 3px rgba(60, 64, 67, 0.3), 0 4px 8px 3px rgba(60, 64, 67, 0.15);
            --shadow-lg: 0 4px 8px rgba(60, 64, 67, 0.3), 0 8px 16px 4px rgba(60, 64, 67, 0.15);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 24px;
            --radius-full: 9999px;
            --transition: 200ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ========================================
           RESET & BASE
           ======================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--on-surface);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ========================================
           FULL SCREEN MAP CONTAINER
           ======================================== */
        #map {
            position: fixed;
            inset: 0;
            z-index: 1;
        }

        /* Hide default Leaflet zoom control - we use custom */
        .leaflet-control-zoom {
            display: none !important;
        }

        .leaflet-control-attribution {
            font-size: 10px !important;
            background: rgba(255, 255, 255, 0.8) !important;
            padding: 2px 6px !important;
        }

        @media (max-width: 600px) {
            .leaflet-control-attribution {
                display: none !important;
            }
        }

        /* ========================================
           BACK BUTTON (Top Left)
           ======================================== */
        .back-btn {
            position: fixed;
            top: 16px;
            left: 16px;
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--surface);
            color: var(--on-surface);
            text-decoration: none;
            padding: 10px 16px 10px 12px;
            border-radius: var(--radius-full);
            box-shadow: var(--shadow-md);
            font-size: 14px;
            font-weight: 500;
            transition: all var(--transition);
        }

        .back-btn:hover {
            background: var(--surface-variant);
            box-shadow: var(--shadow-lg);
            transform: translateX(-2px);
        }

        .back-btn:active {
            transform: scale(0.98);
        }

        .back-btn .material-icons-round {
            font-size: 20px;
            color: var(--on-surface-variant);
        }

        /* ========================================
           FLOATING SEARCH BAR (Top Left)
           ======================================== */
        .search-container {
            position: fixed;
            top: 16px;
            left: 140px;
            z-index: 1000;
            width: min(320px, calc(100% - 160px));
        }

        @media (max-width: 500px) {
            .search-container {
                left: 16px;
                top: 70px;
                width: calc(100% - 32px);
            }
        }

        .search-bar {
            display: flex;
            align-items: center;
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: 4px 8px 4px 16px;
            gap: 8px;
            transition: box-shadow var(--transition);
        }

        .search-bar:focus-within {
            box-shadow: var(--shadow-lg);
        }

        .search-bar .menu-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            border-radius: var(--radius-full);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--on-surface-variant);
            transition: background var(--transition);
        }

        .search-bar .menu-btn:hover {
            background: var(--surface-variant);
        }

        .search-bar input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 16px;
            color: var(--on-surface);
            background: transparent;
            padding: 12px 0;
        }

        .search-bar input::placeholder {
            color: var(--on-surface-variant);
        }

        .search-bar .voice-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            border-radius: var(--radius-full);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            transition: background var(--transition);
        }

        .search-bar .voice-btn:hover {
            background: rgba(66, 133, 244, 0.1);
        }

        /* ========================================
           FLOATING CONTROL BUTTONS (Bottom Right)
           ======================================== */
        .map-controls {
            position: fixed;
            bottom: 180px;
            right: 16px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-btn {
            width: 48px;
            height: 48px;
            border: none;
            background: var(--surface);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--on-surface-variant);
            transition: all var(--transition);
        }

        .control-btn:hover {
            background: var(--surface-variant);
            color: var(--on-surface);
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .control-btn.active {
            background: var(--primary);
            color: white;
        }

        .control-btn .material-icons-round {
            font-size: 24px;
        }

        .zoom-controls {
            display: flex;
            flex-direction: column;
            background: var(--surface);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }

        .zoom-controls .control-btn {
            box-shadow: none;
            border-radius: 0;
        }

        .zoom-controls .control-btn:first-child {
            border-bottom: 1px solid var(--outline);
        }

        /* ========================================
           INFO PANEL - Desktop (Left Sidebar)
           ======================================== */
        .info-panel {
            position: fixed;
            top: 80px;
            left: 16px;
            z-index: 999;
            width: 360px;
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            transform: translateX(-120%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .info-panel.visible {
            transform: translateX(0);
        }

        .panel-header {
            padding: 20px;
            border-bottom: 1px solid var(--outline);
        }

        .panel-title {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .panel-title .icon-circle {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--danger), #ff6b6b);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .panel-title h2 {
            font-size: 18px;
            font-weight: 600;
            color: var(--on-surface);
        }

        .panel-subtitle {
            font-size: 14px;
            color: var(--on-surface-variant);
            margin-left: 52px;
        }

        .panel-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            padding: 20px;
        }

        .stat-card {
            background: var(--surface-variant);
            border-radius: var(--radius-md);
            padding: 16px;
            text-align: center;
            transition: all var(--transition);
        }

        .stat-card:hover {
            background: rgba(66, 133, 244, 0.1);
            transform: translateY(-2px);
        }

        .stat-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--on-surface);
            line-height: 1.2;
        }

        .stat-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--on-surface-variant);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        .panel-actions {
            display: flex;
            gap: 12px;
            padding: 0 20px 20px;
        }

        .action-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 20px;
            border: none;
            border-radius: var(--radius-full);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition);
        }

        .action-btn.primary {
            background: var(--primary);
            color: white;
        }

        .action-btn.primary:hover {
            background: var(--primary-dark);
            box-shadow: var(--shadow-sm);
        }

        .action-btn.secondary {
            background: var(--surface-variant);
            color: var(--on-surface);
        }

        .action-btn.secondary:hover {
            background: var(--outline);
        }

        /* ========================================
           BOTTOM SHEET - Mobile
           ======================================== */
        @media (max-width: 768px) {
            .info-panel {
                top: auto;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                border-radius: var(--radius-lg) var(--radius-lg) 0 0;
                transform: translateY(calc(100% - 100px));
                max-height: 70vh;
            }

            .info-panel.visible {
                transform: translateY(0);
            }

            .info-panel.minimized {
                transform: translateY(calc(100% - 100px));
            }

            .panel-handle {
                display: flex;
                justify-content: center;
                padding: 12px 0 8px;
                cursor: grab;
            }

            .panel-handle::before {
                content: '';
                width: 40px;
                height: 4px;
                background: var(--outline);
                border-radius: var(--radius-full);
            }

            .map-controls {
                bottom: 120px;
            }
        }

        @media (min-width: 769px) {
            .panel-handle {
                display: none;
            }
        }

        /* ========================================
           BLUE PULSING MARKER (My Location)
           ======================================== */
        .my-location-marker {
            position: relative;
            width: 20px;
            height: 20px;
        }

        .my-location-dot {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            background: var(--primary);
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(66, 133, 244, 0.5);
            z-index: 2;
        }

        .my-location-pulse {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            background: rgba(66, 133, 244, 0.3);
            border-radius: 50%;
            animation: pulse 2s ease-out infinite;
        }

        @keyframes pulse {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }

            100% {
                transform: translate(-50%, -50%) scale(4);
                opacity: 0;
            }
        }

        /* ========================================
           RED PIN MARKER (Target/Device)
           ======================================== */
        .target-marker {
            position: relative;
            width: 30px;
            height: 42px;
        }

        .target-pin {
            position: absolute;
            top: 0;
            left: 50%;
            width: 30px;
            height: 30px;
            background: var(--danger);
            border: 3px solid white;
            border-radius: 50% 50% 50% 0;
            transform: translateX(-50%) rotate(-45deg);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        .target-pin::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
        }

        /* ========================================
           FLOATING INFO CARD (Route Summary)
           ======================================== */
        .route-summary {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 998;
            background: var(--surface);
            padding: 12px 24px;
            border-radius: var(--radius-full);
            box-shadow: var(--shadow-lg);
            display: none;
            align-items: center;
            gap: 16px;
        }

        .route-summary.visible {
            display: flex;
        }

        .route-metric {
            text-align: center;
        }

        .route-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--on-surface);
        }

        .route-label {
            font-size: 10px;
            font-weight: 500;
            color: var(--on-surface-variant);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .route-divider {
            width: 1px;
            height: 32px;
            background: var(--outline);
        }

        @media (max-width: 768px) {
            .route-summary {
                display: none !important;
            }
        }

        /* ========================================
           LOADING OVERLAY
           ======================================== */
        .loading-overlay {
            position: fixed;
            inset: 0;
            z-index: 2000;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 24px;
            transition: opacity 0.4s ease, visibility 0.4s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .loading-logo {
            font-size: 48px;
            animation: float 2s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: white;
            font-size: 18px;
            font-weight: 600;
        }

        .loading-subtext {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            margin-top: -16px;
        }

        /* ========================================
           TOAST NOTIFICATIONS
           ======================================== */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            z-index: 1100;
            background: var(--on-surface);
            color: white;
            padding: 14px 24px;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 500;
            box-shadow: var(--shadow-lg);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-logo">üìç</div>
        <div class="loading-spinner"></div>
        <div class="loading-text">ƒêang x√°c ƒë·ªãnh v·ªã tr√≠...</div>
        <div class="loading-subtext">Vui l√≤ng cho ph√©p truy c·∫≠p GPS</div>
    </div>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Back Button -->
    <a href="index.html" class="back-btn" title="Quay l·∫°i trang ch·ªß">
        <span class="material-icons-round">arrow_back</span>
        <span>Quay l·∫°i</span>
    </a>

    <!-- Floating Search Bar -->
    <div class="search-container">
        <div class="search-bar">
            <span class="material-icons-round"
                style="color: var(--on-surface-variant); margin-right: 8px;">search</span>
            <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm ƒë·ªãa ƒëi·ªÉm..." autocomplete="off">
            <button class="voice-btn" title="T√¨m b·∫±ng gi·ªçng n√≥i">
                <span class="material-icons-round">mic</span>
            </button>
        </div>
    </div>

    <!-- Floating Control Buttons -->
    <div class="map-controls">
        <button class="control-btn" id="layersBtn" title="ƒê·ªïi ki·ªÉu b·∫£n ƒë·ªì">
            <span class="material-icons-round">layers</span>
        </button>
        <div class="zoom-controls">
            <button class="control-btn" id="zoomInBtn" title="Ph√≥ng to">
                <span class="material-icons-round">add</span>
            </button>
            <button class="control-btn" id="zoomOutBtn" title="Thu nh·ªè">
                <span class="material-icons-round">remove</span>
            </button>
        </div>
        <button class="control-btn" id="myLocationBtn" title="V·ªã tr√≠ c·ªßa t√¥i">
            <span class="material-icons-round">my_location</span>
        </button>
    </div>

    <!-- Info Panel (Desktop: Sidebar / Mobile: Bottom Sheet) -->
    <div class="info-panel" id="infoPanel">
        <div class="panel-handle"></div>
        <div class="panel-header">
            <div class="panel-title">
                <div class="icon-circle">
                    <span class="material-icons-round">location_on</span>
                </div>
                <h2 id="panelTitle">Thi·∫øt b·ªã GPS</h2>
            </div>
            <p class="panel-subtitle" id="panelSubtitle">ƒêang theo d√µi v·ªã tr√≠...</p>
        </div>
        <div class="panel-stats">
            <div class="stat-card">
                <div class="stat-icon">üìè</div>
                <div class="stat-value" id="distanceValue">--</div>
                <div class="stat-label">Kho·∫£ng c√°ch</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚è±Ô∏è</div>
                <div class="stat-value" id="timeValue">--</div>
                <div class="stat-label">Th·ªùi gian</div>
            </div>
        </div>
        <div class="panel-actions">
            <button class="action-btn secondary" id="refreshBtn">
                <span class="material-icons-round">refresh</span>
                L√†m m·ªõi
            </button>
            <button class="action-btn primary" id="navigateBtn">
                <span class="material-icons-round">navigation</span>
                Ch·ªâ ƒë∆∞·ªùng
            </button>
        </div>
    </div>

    <!-- Route Summary (Desktop only - floating at bottom) -->
    <div class="route-summary" id="routeSummary">
        <div class="route-metric">
            <div class="route-value" id="routeDistance">--</div>
            <div class="route-label">Kho·∫£ng c√°ch</div>
        </div>
        <div class="route-divider"></div>
        <div class="route-metric">
            <div class="route-value" id="routeTime">--</div>
            <div class="route-label">Th·ªùi gian</div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // ================================================================
        // CONFIGURATION - DO NOT TOUCH
        // ================================================================
        const CONFIG = {
            API_KEY: '0a644553a21342579ef5d0726fe7f3d3',
            TILES_URL: 'https://maps.geoapify.com/v1/tile/osm-bright/{z}/{x}/{y}.png',
            ROUTING_URL: 'https://api.geoapify.com/v1/routing',
            DEFAULT_ZOOM: 15,
            FIT_BOUNDS_PADDING: [80, 80]
        };

        // ================================================================
        // GLOBAL VARIABLES
        // ================================================================
        let map = null;
        let myLocationMarker = null;
        let targetMarker = null;
        let routeLayer = null;
        let routeOutline = null;
        let currentMyLocation = null;
        let currentTargetPosition = null;

        // ================================================================
        // TARGET POSITION FUNCTION - DO NOT TOUCH LOGIC
        // ================================================================
        async function getTargetPosition() {
            // Hardcoded for testing - Replace with Cloudflare API fetch
            return {
                lat: 10.901146,
                lng: 106.806184
            };
        }

        // ================================================================
        // GET MY LOCATION (Browser Geolocation) - DO NOT TOUCH
        // ================================================================
        function getMyLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ GPS'));
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        });
                    },
                    (error) => {
                        let message = 'Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠: ';
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                message = 'B·∫°n ƒë√£ t·ª´ ch·ªëi quy·ªÅn truy c·∫≠p v·ªã tr√≠.\n\nVui l√≤ng v√†o C√†i ƒë·∫∑t > Quy·ªÅn ri√™ng t∆∞ > V·ªã tr√≠ ƒë·ªÉ b·∫≠t l·∫°i.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                message = 'Kh√¥ng th·ªÉ x√°c ƒë·ªãnh v·ªã tr√≠ c·ªßa b·∫°n.';
                                break;
                            case error.TIMEOUT:
                                message = 'Y√™u c·∫ßu v·ªã tr√≠ ƒë√£ h·∫øt th·ªùi gian.';
                                break;
                        }
                        reject(new Error(message));
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 0
                    }
                );
            });
        }

        // ================================================================
        // INITIALIZE MAP
        // ================================================================
        function initMap(center) {
            map = L.map('map', {
                center: [center.lat, center.lng],
                zoom: CONFIG.DEFAULT_ZOOM,
                zoomControl: false // We use custom controls
            });

            // Add Geoapify tiles
            L.tileLayer(`${CONFIG.TILES_URL}?apiKey=${CONFIG.API_KEY}`, {
                maxZoom: 20,
                attribution: '¬© <a href="https://www.geoapify.com/">Geoapify</a>'
            }).addTo(map);
        }

        // ================================================================
        // ADD MY LOCATION MARKER (Blue Pulsing Circle) - DO NOT TOUCH
        // ================================================================
        function addMyLocationMarker(coords) {
            const icon = L.divIcon({
                className: '',
                html: `
                    <div class="my-location-marker">
                        <div class="my-location-pulse"></div>
                        <div class="my-location-dot"></div>
                    </div>
                `,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });

            myLocationMarker = L.marker([coords.lat, coords.lng], { icon })
                .addTo(map)
                .bindPopup('<strong>V·ªã tr√≠ c·ªßa b·∫°n</strong>');
        }

        // ================================================================
        // ADD TARGET MARKER (Red Pin) - DO NOT TOUCH
        // ================================================================
        function addTargetMarker(coords) {
            const icon = L.divIcon({
                className: '',
                html: `
                    <div class="target-marker">
                        <div class="target-pin"></div>
                    </div>
                `,
                iconSize: [30, 42],
                iconAnchor: [15, 42]
            });

            targetMarker = L.marker([coords.lat, coords.lng], { icon })
                .addTo(map)
                .bindPopup('<strong>Thi·∫øt b·ªã GPS</strong><br>ƒêi·ªÉm ƒë·∫øn');
        }

        // ================================================================
        // CALCULATE & DRAW ROUTE
        // ================================================================
        async function calculateRoute(origin, destination) {
            const waypoints = `${origin.lat},${origin.lng}|${destination.lat},${destination.lng}`;
            const url = `${CONFIG.ROUTING_URL}?waypoints=${waypoints}&mode=drive&apiKey=${CONFIG.API_KEY}`;

            try {
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();

                if (!data.features || data.features.length === 0) {
                    throw new Error('Kh√¥ng t√¨m th·∫•y ƒë∆∞·ªùng ƒëi');
                }

                const feature = data.features[0];
                const props = feature.properties;

                // CRITICAL: GeoJSON uses [lng, lat], Leaflet uses [lat, lng]
                const coordinates = feature.geometry.coordinates.map(
                    coord => [coord[1], coord[0]]
                );

                // Draw route
                drawRoute(coordinates);

                // Update UI
                updateRouteInfo(props.distance, props.time);

                // Fit bounds to show both points
                fitBounds(origin, destination);

                return { distance: props.distance, time: props.time };

            } catch (error) {
                console.error('[Routing Error]', error);
                showToast('L·ªói t√≠nh ƒë∆∞·ªùng ƒëi: ' + error.message);
                throw error;
            }
        }

        // ================================================================
        // DRAW ROUTE POLYLINE
        // ================================================================
        function drawRoute(coordinates) {
            // Remove existing routes
            if (routeOutline) map.removeLayer(routeOutline);
            if (routeLayer) map.removeLayer(routeLayer);

            // White outline (drawn first)
            routeOutline = L.polyline(coordinates, {
                color: '#ffffff',
                weight: 8,
                opacity: 1,
                lineCap: 'round',
                lineJoin: 'round'
            }).addTo(map);

            // Blue route (on top)
            routeLayer = L.polyline(coordinates, {
                color: '#4285F4',
                weight: 5,
                opacity: 1,
                lineCap: 'round',
                lineJoin: 'round'
            }).addTo(map);
        }

        // ================================================================
        // UPDATE ROUTE INFO (Panel + Summary)
        // ================================================================
        function updateRouteInfo(distanceMeters, timeSeconds) {
            // Format distance
            let distanceText;
            if (distanceMeters >= 1000) {
                distanceText = (distanceMeters / 1000).toFixed(1) + ' km';
            } else {
                distanceText = Math.round(distanceMeters) + ' m';
            }

            // Format time
            const totalMinutes = Math.round(timeSeconds / 60);
            let timeText;
            if (totalMinutes >= 60) {
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                timeText = `${hours}h ${minutes}p`;
            } else {
                timeText = `${totalMinutes} ph√∫t`;
            }

            // Update Panel
            document.getElementById('distanceValue').textContent = distanceText;
            document.getElementById('timeValue').textContent = timeText;
            document.getElementById('panelSubtitle').textContent = `${distanceText} ‚Ä¢ ${timeText} ƒëi xe`;

            // Update Route Summary (desktop)
            document.getElementById('routeDistance').textContent = distanceText;
            document.getElementById('routeTime').textContent = timeText;

            // Show elements
            document.getElementById('infoPanel').classList.add('visible');
            document.getElementById('routeSummary').classList.add('visible');
        }

        // ================================================================
        // FIT MAP BOUNDS
        // ================================================================
        function fitBounds(origin, destination) {
            const bounds = L.latLngBounds([
                [origin.lat, origin.lng],
                [destination.lat, destination.lng]
            ]);

            map.fitBounds(bounds, {
                padding: CONFIG.FIT_BOUNDS_PADDING,
                maxZoom: 16
            });
        }

        // ================================================================
        // UI HELPERS
        // ================================================================
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), duration);
        }

        // ================================================================
        // CONTROL BUTTON HANDLERS
        // ================================================================
        function setupControls() {
            // Zoom In
            document.getElementById('zoomInBtn').addEventListener('click', () => {
                map.zoomIn();
            });

            // Zoom Out
            document.getElementById('zoomOutBtn').addEventListener('click', () => {
                map.zoomOut();
            });

            // My Location
            document.getElementById('myLocationBtn').addEventListener('click', () => {
                if (currentMyLocation) {
                    map.setView([currentMyLocation.lat, currentMyLocation.lng], 16);
                    showToast('ƒê√£ di chuy·ªÉn ƒë·∫øn v·ªã tr√≠ c·ªßa b·∫°n');
                }
            });

            // Layers toggle (placeholder)
            document.getElementById('layersBtn').addEventListener('click', () => {
                showToast('T√≠nh nƒÉng ƒë·ªïi b·∫£n ƒë·ªì ƒëang ph√°t tri·ªÉn');
            });

            // Menu button
            document.getElementById('menuBtn').addEventListener('click', () => {
                const panel = document.getElementById('infoPanel');
                panel.classList.toggle('visible');
            });

            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', async () => {
                showToast('ƒêang l√†m m·ªõi...');
                try {
                    const myLocation = await getMyLocation();
                    const targetPosition = await getTargetPosition();

                    // Update marker positions
                    myLocationMarker.setLatLng([myLocation.lat, myLocation.lng]);
                    targetMarker.setLatLng([targetPosition.lat, targetPosition.lng]);

                    // Recalculate route
                    await calculateRoute(myLocation, targetPosition);

                    currentMyLocation = myLocation;
                    currentTargetPosition = targetPosition;

                    showToast('ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng!');
                } catch (error) {
                    showToast('L·ªói: ' + error.message);
                }
            });

            // Navigate button - Open in Google Maps
            document.getElementById('navigateBtn').addEventListener('click', () => {
                if (currentTargetPosition) {
                    const url = `https://www.google.com/maps/dir/?api=1&destination=${currentTargetPosition.lat},${currentTargetPosition.lng}`;
                    window.open(url, '_blank');
                }
            });

            // Mobile: Bottom sheet drag (simplified)
            const panelHandle = document.querySelector('.panel-handle');
            if (panelHandle) {
                panelHandle.addEventListener('click', () => {
                    const panel = document.getElementById('infoPanel');
                    panel.classList.toggle('minimized');
                });
            }
        }

        // ================================================================
        // MAIN APP INITIALIZATION
        // ================================================================
        async function initApp() {
            console.log('[App] Starting GPS Tracker...');

            try {
                // Step 1: Get my location (browser GPS)
                console.log('[App] Requesting browser location...');
                const myLocation = await getMyLocation();
                console.log('[App] My location:', myLocation);
                currentMyLocation = myLocation;

                // Step 2: Get target position (from function - easy to replace)
                console.log('[App] Getting target position...');
                const targetPosition = await getTargetPosition();
                console.log('[App] Target position:', targetPosition);
                currentTargetPosition = targetPosition;

                // Step 3: Initialize map centered on my location
                initMap(myLocation);

                // Step 4: Setup control buttons
                setupControls();

                // Step 5: Add markers
                addMyLocationMarker(myLocation);
                addTargetMarker(targetPosition);

                // Step 6: Calculate and draw route
                console.log('[App] Calculating route...');
                await calculateRoute(myLocation, targetPosition);

                // Step 7: Hide loading overlay
                hideLoading();

                console.log('[App] Initialization complete!');

            } catch (error) {
                console.error('[App] Initialization failed:', error);
                hideLoading();
                alert(error.message);
            }
        }

        // ================================================================
        // START THE APP
        // ================================================================
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>

</html>
